<app-menu-title-row>
  <div class="col app-right-column breadcrumbs">
    <a routerLink="..">{{clinic?.name}}</a>
    <app-chevron-right></app-chevron-right>
    {{unit?.name}}
  </div>
</app-menu-title-row>

<app-row>
  <app-left-column>
    <h3>Dagens meddelanden:</h3>
    <vgr-panel-container class="button-row">
      <vgr-panel *ngFor="let message of messages">
        <app-message [message]="message"></app-message>
      </vgr-panel>
    </vgr-panel-container>
    <a routerLink="editMessages" *ngIf="hasEditUnitPermission()">
      <div class="icon-with-text vgr-icon-edit">Redigera meddelanden</div>
    </a>
    <div style="margin-top: 20px" *ngIf="unit?.hasMotherChildDietFeature || unit?.hasKostFeature">
      <a [href]="'/api/unit/' + clinic.id + '/' + unit.id + '/kostLista'" target="_blank" style="text-decoration: none "><h3>Kostlista</h3></a>
    </div>
  </app-left-column>

  <app-right-column>
    <div>
      <vgr-page-block *ngIf="unit">
        <div>
          <div *ngIf="showChangeBedOrder">
            <p>Dra och släpp sängarna och spara sedan.</p>
            <div dragula="ROWS" [(dragulaModel)]="bedsOrder">
              <div class="order-row" *ngFor="let bed of unit.beds">
                {{bed.label}} <span class="ssk-color ssk-{{bed.ssk?.color}}"></span>
              </div>
            </div>

            <div class="button-row">
              <vgr-save-cancel [hideLock]="true" (save)="saveBedOrder()"
                               (cancel)="hideChangeBedOrder()"></vgr-save-cancel>
            </div>
          </div>

          <div *ngIf="!showChangeBedOrder">
            <vgr-list [flexibleHeader]="true">
              <vgr-list-header>
                <vgr-list-column-header width="2">Rum/säng</vgr-list-column-header>
                <vgr-list-column-header width="2">SSK</vgr-list-column-header>
                <vgr-list-column-header width="2">Status</vgr-list-column-header>
                <vgr-list-column-header width="2">Patient</vgr-list-column-header>
                <vgr-list-column-header width="2">Kön</vgr-list-column-header>
                <vgr-list-column-header width="8">Översikt</vgr-list-column-header>
              </vgr-list-header>

              <vgr-list-item *ngFor="let bed of unit?.beds" #theListItem>

                <vgr-list-item-header>
                  <vgr-list-column width="2">{{bed.label}}</vgr-list-column>
                  <vgr-list-column width="2"><span class="ssk-color ssk-{{bed.ssk?.color}}"></span></vgr-list-column>
                  <vgr-list-column width="2"><span class="status-color status-{{bed.occupied ? 'OCCUPIED' : 'VACANT'}}" [appCallout]="bed.occupied ? 'Upptagen' : 'Ledig'"></span></vgr-list-column>
                  <vgr-list-column width="2">{{bed.patient?.label}}</vgr-list-column>
                  <vgr-list-column width="2" *ngIf="bed.patient?.gender === 'MAN'"><i class="fa fa-male purpule"[appCallout]="'Man'" ></i></vgr-list-column>
                  <vgr-list-column width="2" *ngIf="bed.patient?.gender === 'KVINNA'"><i class="fa fa-female purpule" [appCallout]="'Kvinna'"></i></vgr-list-column>
                  <vgr-list-column width="2" *ngIf="bed.patient?.gender === 'BARN'"><i class="fa fa-child purpule" [appCallout]="'Barn'"></i></vgr-list-column>
                  <vgr-list-column width="8">
                    <div class="ikon" *ngIf="bed.patient?.plannedLeaveDate != null"
                         [appCallout]="'Planerad hemgång: ' +bed.patient?.plannedLeaveDate"><i class="fa fa-home purpule"></i>
                    </div>

                    <div class="ikon" *ngIf="unit.servingClinics.length != 0 &&  bed.servingClinic != null || bed.patientWaits"
                         [appCallout]="(bed.servingClinic?.name != null)? 'Ny patient väntar från: ' + bed.servingClinic?.name: 'Ny patient väntar'">
                      <i class="fa fa-wheelchair purpule"></i>
                    </div>


                    <div class="ikon" *ngIf="bed.patient?.carePlan?.length > 0"
                         [appCallout]="'Vårdplan: ' + bed.patient?.carePlan"><span class="material-icons purpule">list_alt</span>
                    </div>

                    <div class="ikon" *ngIf="bed.patient?.interpreter"
                         [appCallout]="'Tolk' + (bed.patient?.interpretDate ? ': ' + bed.patient.interpretDate : '')"><i class="material-icons purpule">translate</i>
                    </div>

                    <div class="ikon" *ngIf="bed.patient?.patientExaminations.length > 0"
                         [appCallout]="'Patient har bokade undersökningar'"><i class="fa fa-stethoscope purpule"></i>
                    </div>

                    <div class="ikon" *ngIf="bed.relatedInformation?.length > 0"
                         [appCallout]="'Övrig information finns'"><i class="fa fa-info-circle purpule"></i>
                    </div>

                    <div class="ikon" *ngIf="bed.patient?.akutPatient && unit.hasAkutPatientFeature"
                         [appCallout]="'Akut patient'"><i class="fa fa-ambulance purpule"></i>
                    </div>

                    <div class="ikon" *ngIf="bed.patient?.electiv23O && unit.has23oFeature"
                         [appCallout]="'Electiv 23O'"><i class="fa fa-bed purpule"></i>
                    </div>

                    <div class="ikon" *ngIf="bed.patient?.electiv24O && unit.has24oFeature"
                         [appCallout]="'Electiv 24O'"><i class="fa fa-bed purpule"></i>
                    </div>

                    <div class="ikon" *ngIf="bed.patient?.vuxenPatient && bed.patient.gender !== 'BARN' && unit.hasVuxenPatientFeature"
                         [appCallout]="'Vuxen Patient'"><i class="fa fa-male purpule" *ngIf="bed.patient.gender === 'MAN'"></i>
                      <i class="fa fa-female purpule" *ngIf="bed.patient.gender === 'KVINNA'"></i>
                    </div>

                    <div class="ikon" *ngIf="bed.patient?.vuxenPatient && bed.patient.gender === 'BARN' && unit.hasVuxenPatientFeature"
                         [appCallout]="'Vuxen barn'"><i class="fa fa-child purpule" *ngIf="bed.patient.gender === 'BARN'"></i>

                    </div>

                    <div class="ikon" *ngIf="bed.patient?.sekretess && unit.hasSekretessFeature"
                         [appCallout]="'Sekretess'"><i class="fa fa-user-secret purpule"></i>
                    </div>

                    <div class="ikon" *ngIf="bed.patient?.infekterad && unit.hasInfekteradFeature"
                         [appCallout]="'Infekterad'"><i class="fa fa-male rod" *ngIf="bed.patient.gender === 'MAN'"></i>
                      <i class="fa fa-female rod" *ngIf="bed.patient.gender === 'KVINNA'"></i>
                      <i class="fa fa-child rod" *ngIf="bed.patient.gender === 'BARN'"></i>
                    </div>

                    <div class="ikon" *ngIf="bed.patient?.infectionSensitive && unit.hasInfectionSensitiveFeature"
                         [appCallout]="'Infektionskänslig'"><i class="material-icons rod">grain</i>
                    </div>

                    <div class="ikon" *ngIf="bed.patient?.smitta && unit.hasSmittaFeature"
                         [appCallout]="'Smitta'"><i class="fa fa-bug rod"></i>
                    </div>

                    <div class="ikon" *ngIf="bed.cleaningalternativeExists && unit.hasCleaningFeature"
                         [appCallout]="'Städ ' + ((bed.cleaningalternativeExists && bed.cleaningAlternative?.description) ? ': ' + bed.cleaningAlternative.description : '')"><i class="fa fa-leaf purpule"></i>
                    </div>

                    <div class="ikon" *ngIf="bed.patient?.pal && unit.hasPalFeature"
                         [appCallout]="'PAL: ' + bed.patient.pal"><i class="fa fa-user-md purpule"></i>
                    </div>

                    <div class="ikon" *ngIf="bed.patient?.patientEvents?.length > 0 && unit.hasHendelseFeature"
                         [appCallout]="'Händelser finns'"><i class="fa fa-tasks purpule"></i>
                    </div>

                    <div class="ikon" *ngIf="bed.patient?.barnRond && unit.hasRondFeature"
                         [appCallout]="'Rond Barn'"><i class="material-icons purpule">child_care</i>
                    </div>

                    <div class="ikon" *ngIf="bed.patient?.morRond && unit.hasRondFeature"
                         [appCallout]="'Rond Mor'"><i class="fa fa-user purpule"></i>
                    </div>

                    <div class="ikon" *ngIf="bed.patient?.rond && unit.hasRondFeature"
                         [appCallout]="'Rond'"><i class="fa fa-user-circle purpule"></i>
                    </div>

                    <div class="ikon" *ngIf="bed.patient?.amning === '1' && unit.hasAmningFeature"
                         [appCallout]="'Normal amning'"><i class="fa fa-circle-o purpule"></i>
                    </div>
                    <div class="ikon" *ngIf="bed.patient?.amning === '2' && unit.hasAmningFeature"
                         [appCallout]="'Amningshjälp'"><i class="fa fa-dot-circle-o purpule"></i>
                    </div>
                    <div class="ikon" *ngIf="bed.patient?.amning === '3' && unit.hasAmningFeature"
                         [appCallout]="'Amnings mottagning'"><i class="fa fa-dot-circle-o purpule"></i> <i class="fa fa-dot-circle-o purpule__np"></i>
                    </div>

                    <div class="ikon" *ngIf="bed.patient?.information === '1' && unit.hasInfoFeature"
                         [appCallout]="'THG'"><i class="fa fa-undo purpule"></i>
                    </div>
                    <div class="ikon" *ngIf="bed.patient?.information === '2' && unit.hasInfoFeature"
                         [appCallout]="'THG med barn'"><i class="fa fa-odnoklassniki purpule"></i>
                    </div>
                    <div class="ikon" *ngIf="bed.patient?.information === '3' && unit.hasInfoFeature"
                         [appCallout]="'Föräldrarum'"><i class="fa fa-weixin purpule"></i>
                    </div>

                </vgr-list-column>
              </vgr-list-item-header>

                <vgr-list-item-content [indentContent]="true">

                  <app-bed-form [clinicId]="clinic.id"
                                [unit]="unit"
                                [bed]="bed"
                                [careBurdenValuesOptions]="careBurdenValuesOptions"
                                [amningOptions]="amningOptions"
                                [dietMotherDropdownItems]="dietMotherDropdownItems"
                                [dietChildDropdownItems]="dietChildDropdownItems"
                                [dietDropdownItems]="dietDropdownItems"
                                [informationOptions] = "informationOptions"
                                [genderDropdownItems]="genderDropdownItems"
                                [leaveStatusesDropdownItems]="leaveStatusesDropdownItems"
                                [sskDropdownItems]="sskDropdownItems"
                                [servingKlinikerDropdownItems]="servingKlinikerDropdownItems"
                                [cleaningAlternativesDropdownItems]="cleaningAlternativesDropdownItems"
                                (collapse)="collapse(theListItem)"
                                (openDeleteModal)="openDeleteModal(bed)"
                                (save)="ngOnInit()"
                                *ngIf="theListItem.expanded"> <!-- Speeds up page performance -->

                  </app-bed-form>


                </vgr-list-item-content>

              </vgr-list-item>

              <vgr-list-item #addListItem>
                <vgr-list-item-header>
                  <vgr-list-column width="5">
                    <div class="add-row vgr-icon-plus">Lägg till säng</div>
                  </vgr-list-column>
                </vgr-list-item-header>

                <vgr-list-item-content [indentContent]="true">
                  <form [formGroup]="addBedForm" (ngSubmit)="saveAddBed()">
                    <div class="containers">
                      <div style="flex-grow: 8; flex-shrink: 0">
                        <div>Benämning</div>
                        <vgr-input formControlName="label" [showValidation]="!addBedForm.get('label').valid && addBedForm.get('label').touched"> </vgr-input>
                      </div>

                      <div class="clearfix button-row" style="flex-grow: 1; flex-shrink: 0">
                        <vgr-button [secondary]="false" default="true" (click)="saveAddBed()" [disabled]="!addBedForm.valid">Spara</vgr-button>
                        <vgr-button [secondary]="false" default="true" (click)="collapse(addListItem)" >Avbryt</vgr-button>
                      </div>
                    </div>

                  </form>
                </vgr-list-item-content>
              </vgr-list-item>
            </vgr-list>
            <div class="button-row">
              <vgr-button (click)="changeBedOrder()">Byt ordning</vgr-button>
            </div>
          </div>
        </div>

      </vgr-page-block>

      <vgr-page-block *ngIf="unit?.patients.length > 0">
        <vgr-list [flexibleHeader]="true">

          <vgr-list-header>
            <vgr-list-column-header width="10">Permission / teknisk plats</vgr-list-column-header>
          </vgr-list-header>

          <vgr-list-item *ngFor="let patient of unit?.patients" #leavePatientItem>
            <vgr-list-item-header>
              <vgr-list-column width="5">{{patient.label}}</vgr-list-column>
              <vgr-list-column width="5">{{format(patient.leaveStatus)}}</vgr-list-column>
            </vgr-list-item-header>

            <vgr-list-item-content>
              Välj ledig säng
              <vgr-dropdown noItemSelectedLabel="Välj..." [items]="vacantBeds"
                            [(ngModel)]="chosenVacantBedId"></vgr-dropdown>

              <div class="button-row">
                <vgr-button (click)="chooseBedForLeavePatient(patient); collapse(leavePatientItem)">Spara</vgr-button>
              </div>

            </vgr-list-item-content>
          </vgr-list-item>
        </vgr-list>
      </vgr-page-block>

      <vgr-page-block *ngIf="unit?.ssks.length > 0 || unit?.hasCareBurdenWithText || unit?.hasCareBurdenWithAverage">
        <vgr-panel-container>
          <vgr-panel width="4" *ngIf="unit?.ssks.length > 0">
            <table class="vpp-table">
              <thead>
              <tr>
                <th>Vårdlag</th>
                <th>Antal sängar</th>
              </tr>
              </thead>
              <tr *ngFor="let ssk of unit?.ssks">
                <td><span class="ssk-color ssk-{{ssk.color}}"></span> {{ssk.label}}</td>
                <td>{{countBeds(ssk)}}</td>
              </tr>
            </table>
          </vgr-panel>
          <vgr-panel width="6" *ngIf="unit?.hasCareBurdenWithAverage">
            <table class="vpp-table">
              <thead>
              <tr>
                <th>Vårdtyngd</th>
                <th *ngFor="let cbk of unit?.careBurdenCategories" class="pad-left-20">{{cbk.name}}</th>
              </tr>
              </thead>
              <tr *ngFor="let bed of unit?.beds; let i= index" [hidden]="BedHasNoPatientWithCareBurfen(bed.patient)">
                <td>säng{{" "+ bed.label}}</td>
                <td *ngFor="let cbk of unit?.careBurdenCategories" class="pad-left-20">
                  {{patientCareBurden(bed.patient?.careBurdenChoices, cbk.id)}}
                </td>
              </tr>
              <tr>
                <td>Medelvärde:</td>
                <td *ngFor="let cbk of unit?.careBurdenCategories" class="pad-left-20">{{CalculateAverage(cbk.id)}}</td>
              </tr>
            </table>
          </vgr-panel>

          <vgr-panel width="6" *ngIf="unit?.hasCareBurdenWithText">
            <table class="vpp-table">
              <thead>
              <tr>
                <th colspan="7" style="text-align: left">Vårdtyngd</th>
              </tr>
              <tr>
                <th></th>
                <th *ngFor="let cbk of unit?.careBurdenCategories" class="right" colspan="3">{{cbk.name}}</th>
              </tr>
              <tr>
                <th>Vårdlag</th>
                <th *ngFor="let cbv of unit?.careBurdenCategories" colspan="3" class="right">{{burdenvals}}</th>
              </tr>
              </thead>
              <tr *ngFor="let ssk of unit?.ssks">
                <td><span class="ssk-color ssk-{{ssk.color}}"></span></td>
                <td *ngFor="let cbk of unit?.careBurdenCategories" class="pad-left-20" colspan="3">
                <span *ngFor="let value of unit?.careBurdenValues; let i = index">
                  <span *ngIf="i == unit?.careBurdenValues.length-1"> - </span ><span>{{getMatrixValue(ssk, cbk, value)}}</span>
                 </span>
                </td>
              </tr>
            </table>
          </vgr-panel>

        </vgr-panel-container>
      </vgr-page-block>

      <vgr-page-block *ngIf="!unit">
        <div *ngIf="!error">
          <vgr-loader [small]="false"></vgr-loader>
        </div>

        <div *ngIf="error">
          <div class="alert">{{error}}</div>
        </div>
      </vgr-page-block>
    </div>

  </app-right-column>
</app-row>

<app-delete-modal [itemLabel]="bedForDeletion?.label" (confirmDelete)="confirmDelete()"></app-delete-modal>
