<app-menu-title-row>

  <div>
    <div class="col app-right-column breadcrumbs">
      <a routerLink="..">{{clinic?.name}}</a>
      <app-chevron-right></app-chevron-right>
      {{unit?.name}}
    </div>

    <div style="display: inline-block; margin-left:45%;" *ngIf="unit?.hasMotherChildDietFeature || unit?.hasKostFeature">
      <a [href]="'/api/unit/' + clinic.id + '/' + unit.id + '/kostLista'" target="_blank"
         style="text-decoration: none "><h2>Kostlista</h2></a>
    </div>
  </div>
</app-menu-title-row>

<app-row>
  <app-left-column>
    <vgr-page-block>
      <h3>Dagens meddelanden:</h3>
      <vgr-panel-container class="button-row">
        <vgr-panel width="80%" *ngFor="let message of messages" themecolor="green">
          <app-message [message]="message"></app-message>
        </vgr-panel>
      </vgr-panel-container>
      <a routerLink="editMessages" *ngIf="hasEditUnitPermission()">
        <div class="icon-with-text vgr-icon-edit">Redigera meddelanden</div>
      </a>
      <hr/>
      <vgr-panel-container>
        <vgr-panel width="80%" *ngIf="unit?.ssks.length > 0">
          <table class="vpp-table">
            <thead>
            <tr>
              <th>Vårdlag</th>
              <th>Antal sängar</th>
            </tr>
            </thead>
            <tr *ngFor="let ssk of unit?.ssks">
              <td><span class="ssk-color ssk-{{ssk.color}}"></span> {{ssk.label}}</td>
              <td>{{countBeds(ssk)}}</td>
            </tr>
          </table>
        </vgr-panel>
        <vgr-panel width="80%" *ngIf="unit?.hasCareBurdenWithAverage">
          <table class="vpp-table">
            <thead>
            <tr>
              <th>Vårdtyngd</th>
              <th *ngFor="let cbk of unit?.careBurdenCategories" class="pad-left-20">{{cbk.name}}</th>
            </tr>
            </thead>
            <tr *ngFor="let bed of unit?.beds; let i= index" [hidden]="BedHasNoPatientWithCareBurfen(bed.patient)">
              <td>säng{{" "+ bed.label}}</td>
              <td *ngFor="let cbk of unit?.careBurdenCategories" class="pad-left-20">
                {{patientCareBurden(bed.patient?.careBurdenChoices, cbk.id)}}
              </td>
            </tr>
            <tr>
              <td>Medelvärde:</td>
              <td *ngFor="let cbk of unit?.careBurdenCategories" class="pad-left-20">{{CalculateAverage(cbk.id)}}</td>
            </tr>
          </table>
        </vgr-panel>

        <vgr-panel width="80%" *ngIf="unit?.hasCareBurdenWithText">
          <table class="vpp-table">
            <thead>
            <tr>
              <th colspan="7" style="text-align: left">Vårdtyngd</th>
            </tr>
            <tr>
              <th></th>
              <th *ngFor="let cbk of unit?.careBurdenCategories" class="right" colspan="3">{{cbk.name}}</th>
            </tr>
            <tr>
              <th>Vårdlag</th>
              <th *ngFor="let cbv of unit?.careBurdenCategories" colspan="3" class="right">{{burdenvals}}</th>
            </tr>
            </thead>
            <tr *ngFor="let ssk of unit?.ssks">
              <td><span class="ssk-color ssk-{{ssk.color}}"></span></td>
              <td *ngFor="let cbk of unit?.careBurdenCategories" class="pad-left-20" colspan="3">
                <span *ngFor="let value of unit?.careBurdenValues; let i = index">
                  <span *ngIf="i == unit?.careBurdenValues.length-1"> - </span ><span>{{getMatrixValue(ssk, cbk, value)}}</span>
                 </span>
              </td>
            </tr>
          </table>
        </vgr-panel>
      </vgr-panel-container>
    </vgr-page-block>
  </app-left-column>

  <app-right-column>
    <div>
      <vgr-page-block *ngIf="unit">
        <div>
          <div *ngIf="showChangeBedOrder">
            <p>Dra och släpp sängarna och spara sedan.</p>
            <div dragula="ROWS" [(dragulaModel)]="bedsOrder">
              <div class="order-row" *ngFor="let bed of unit.beds">
                {{bed.label}} <span class="ssk-color ssk-{{bed.ssk?.color}}"></span>
              </div>
            </div>

            <div class="button-row">
              <vgr-save-cancel [hideLock]="true" (save)="saveBedOrder()"
                               (cancel)="hideChangeBedOrder()"></vgr-save-cancel>
            </div>
          </div>

          <div *ngIf="!showChangeBedOrder">
            <vgr-list [flexibleHeader]="true">
              <vgr-list-header>
                <vgr-list-column-header width="3">&nbsp;</vgr-list-column-header>
                <vgr-list-column-header width="{{unit.careBurdenCategories.length}}" style="text-align: center;">Vårdtyngd</vgr-list-column-header>
              </vgr-list-header>
              <vgr-list-header>
                <vgr-list-column-header width="2">Rum/säng</vgr-list-column-header>
                <vgr-list-column-header width="1">Status</vgr-list-column-header>
                <!-- Careburdens -->
                <vgr-list-column-header width="1" *ngFor="let cbc of unit.careBurdenCategories">{{cbc.name}}</vgr-list-column-header>
                <vgr-list-column-header width="1">SSK</vgr-list-column-header>
                <vgr-list-column-header width="2">Patient</vgr-list-column-header>
                <vgr-list-column-header width="2">Kön</vgr-list-column-header>
                <vgr-list-column-header width="8">Övrigt</vgr-list-column-header>
              </vgr-list-header>

              <vgr-list-item *ngFor="let bed of unit?.beds" #theListItem [animationSpeed]="400">

                <vgr-list-item-header style="height: 22px;">
                  <vgr-list-column width="2">{{bed.label}}</vgr-list-column>
                  <vgr-list-column width="1"><span class="status-color status-{{bed.occupied ? 'OCCUPIED' : 'VACANT'}}" [appCallout]="bed.occupied ? 'Upptagen' : 'Ledig'"></span></vgr-list-column>

                  <!-- Careburdens -->
                  <vgr-list-column width="1" *ngFor="let cbc of unit.careBurdenCategories; let i = index">{{bed.patient?.careBurdenChoices[i].careBurdenValue?.name}}</vgr-list-column>

                  <vgr-list-column width="1"><span class="ssk-color ssk-{{bed.ssk?.color}}"></span></vgr-list-column>
                  <vgr-list-column width="2">{{bed.patient?.label}}</vgr-list-column>
                  <vgr-list-column width="2" *ngIf="bed.patient?.gender === 'MAN'"><i class="fa fa-male purple"[appCallout]="'Man'" ></i></vgr-list-column>
                  <vgr-list-column width="2" *ngIf="bed.patient?.gender === 'KVINNA'"><i class="fa fa-female purple" [appCallout]="'Kvinna'"></i></vgr-list-column>
                  <vgr-list-column width="2" *ngIf="bed.patient?.gender === 'BARN'"><i class="fa fa-child purple" [appCallout]="'Barn'"></i></vgr-list-column>
                  <vgr-list-column width="2" *ngIf="bed.patient?.gender === null"></vgr-list-column>
                  <vgr-list-column width="8">
                    <app-the-other-bed-icons [bed]="bed" [unit]="unit"></app-the-other-bed-icons>
                  </vgr-list-column>
                </vgr-list-item-header>

                <vgr-list-item-content [indentContent]="true">

                  <app-bed-form [clinicId]="clinic.id"
                                [unit]="unit"
                                [bed]="bed"
                                [careBurdenValuesOptions]="careBurdenValuesOptions"
                                [amningOptions]="amningOptions"
                                [dietMotherDropdownItems]="dietMotherDropdownItems"
                                [dietChildDropdownItems]="dietChildDropdownItems"
                                [dietDropdownItems]="dietDropdownItems"
                                [informationOptions] = "informationOptions"
                                [genderDropdownItems]="genderDropdownItems"
                                [leaveStatusesDropdownItems]="leaveStatusesDropdownItems"
                                [sskDropdownItems]="sskDropdownItems"
                                [servingKlinikerDropdownItems]="servingKlinikerDropdownItems"
                                [cleaningAlternativesDropdownItems]="cleaningAlternativesDropdownItems"
                                (collapse)="collapse(theListItem)"
                                (openDeleteModal)="openDeleteModal(bed)"
                                (save)="ngOnInit()"
                                *ngIf="theListItem.expanded"> <!-- Speeds up page performance -->

                  </app-bed-form>


                </vgr-list-item-content>

              </vgr-list-item>
              <vgr-list-item #plannedunit *ngIf="unit.hasUnitPlannedInFeature">
                <vgr-list-item-header>
                  <vgr-list-column width="6">
                    <div>Planerade patienter från andra enhet</div>
                  </vgr-list-column>
                </vgr-list-item-header>

                <vgr-list-item-content [indentContent]="true">
                  <form *ngIf="addSevenDaysPlaningUnitForm" [formGroup]="addSevenDaysPlaningUnitForm" (ngSubmit)="saveFromEnhet()">
                    <div>
                      <div>
                        <a (click)="addPlannedInUnit()">Lägg till <i class="fa fa-plus-square child"></i></a>
                      </div>
                      <div  formArrayName="sevenDaysPlaningUnits" *ngFor="let planingUnits of sevenDaysPlaningUnits?.controls let i = index;">
                        <div [formGroupName]="i" class="containers">
                          <vgr-datepicker formControlName="date" class="child" [showValidation]="getDatepickerValidation(i)"></vgr-datepicker>
                          <vgr-dropdown-select formControlName="fromUnit" class="child" [showValidation]="getDropdownValidation(i)">
                            <vgr-dropdown-item *ngFor="let item of plannedInDropdownUnits" [value]="item.value">{{item.displayName}}</vgr-dropdown-item>
                          </vgr-dropdown-select>
                          <vgr-input formControlName="quantity" placeholder="antal ... " class="child" [small]="true" [showValidation]="getQuantityValidation(i)"></vgr-input>
                          <vgr-input formControlName="comment" placeholder="kommentar ..." class="child"></vgr-input>
                          <a (click)="deleteSevenDaysPlaningUnit(i)" class="icon-link"><span class="material-icons" >delete</span></a>
                        </div>
                      </div>

                      <div class="clearfix button-row" style="flex-grow: 1; flex-shrink: 0">
                        <vgr-button default="true" (click)="saveFromEnhet(); collapse(plannedunit)" [disabled]="!addSevenDaysPlaningUnitForm.valid">Spara</vgr-button>
                        <vgr-button default="true" (click)="ngOnInit();collapse(plannedunit)" >Avbryt</vgr-button>
                      </div>
                    </div>

                  </form>
                </vgr-list-item-content>
              </vgr-list-item>

              <vgr-list-item #addListItem>
                <vgr-list-item-header>
                  <vgr-list-column width="5">
                    <div class="add-row vgr-icon-plus">Lägg till säng</div>
                  </vgr-list-column>
                </vgr-list-item-header>

                <vgr-list-item-content [indentContent]="true">
                  <form [formGroup]="addBedForm" (ngSubmit)="saveAddBed()">
                    <div class="containers">
                      <div style="flex-grow: 8; flex-shrink: 0">
                        <div>Benämning</div>
                        <vgr-input formControlName="label" [showValidation]="!addBedForm.get('label').valid && addBedForm.get('label').touched"> </vgr-input>
                      </div>

                      <div class="clearfix button-row" style="flex-grow: 1; flex-shrink: 0">
                        <vgr-button default="true" (click)="saveAddBed()" [disabled]="!addBedForm.valid">Spara</vgr-button>
                        <vgr-button default="true" (click)="collapse(addListItem)" >Avbryt</vgr-button>
                      </div>
                    </div>
                  </form>
                </vgr-list-item-content>
              </vgr-list-item>
            </vgr-list>
            <div class="button-row" style="padding-top: 15px">
              <vgr-button (click)="changeBedOrder()">Byt ordning</vgr-button>
            </div>
          </div>
        </div>

      </vgr-page-block>

      <vgr-page-block *ngIf="unit?.patients.length > 0">
        <vgr-list [flexibleHeader]="true">

          <vgr-list-header>
            <vgr-list-column-header width="10">Permission / teknisk plats</vgr-list-column-header>
          </vgr-list-header>

          <vgr-list-item *ngFor="let patient of unit?.patients" #leavePatientItem>
            <vgr-list-item-header>
              <vgr-list-column width="5">{{patient.label}}</vgr-list-column>
              <vgr-list-column width="5">{{format(patient.leaveStatus)}}</vgr-list-column>
            </vgr-list-item-header>

            <vgr-list-item-content>
              Välj ledig säng
              <vgr-dropdown-select noItemSelectedLabel="Välj..." [(ngModel)]="chosenVacantBedId">
                <vgr-dropdown-item *ngFor="let item of vacantBeds" [value]="item.value">{{item.displayName}}</vgr-dropdown-item>
              </vgr-dropdown-select>

              <div class="button-row">
                <vgr-button (click)="chooseBedForLeavePatient(patient); collapse(leavePatientItem)">Spara</vgr-button>
              </div>

            </vgr-list-item-content>
          </vgr-list-item>
        </vgr-list>
      </vgr-page-block>

      <vgr-page-block *ngIf="!unit">
        <div *ngIf="!error">
          <vgr-loader [small]="false"></vgr-loader>
        </div>

        <div *ngIf="error">
          <div class="alert">{{error}}</div>
        </div>
      </vgr-page-block>
    </div>

  </app-right-column>
</app-row>

<app-delete-modal [itemLabel]="bedForDeletion?.label" (confirmDelete)="confirmDelete()"></app-delete-modal>
